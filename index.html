<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TaktLab – Cycle Time & Capacity Analyzer</title>

<style>
/* ====== THEME ====== */
:root{
  --bg-main:#07152b;
  --bg-card:#0b1f3a;
  --bg-card-soft:#0f2544;
  --accent-green:#00c853;
  --accent-amber:#ffb300;
  --accent-red:#ff1744;
  --accent-blue:#29b6f6;
  --accent-grey:#cfd8dc;
  --text-main:#ffffff;
  --text-soft:#c5cae9;
  --text-muted:#90a4ae;
  --border-soft:#1c3357;

  --btn-green:#00c853;
  --btn-orange:#ff9100;
  --btn-grey:#455a64;

  --badge-green:#004d40;
  --badge-red:#b71c1c;
  --badge-amber:#ff8f00;
}

*{box-sizing:border-box;}

body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:linear-gradient(180deg,#020b1a 0%,#07152b 40%,#020b1a 100%);
  color:var(--text-main);
}

.page{
  max-width:1100px;
  margin:0 auto;
  padding:12px 10px 40px;
}

/* ===== STICKY TIMER BAR ===== */
.sticky-timer-bar{
  position:sticky;
  top:0;
  z-index:100;
  background:linear-gradient(180deg,#020b1a 0%,#07152b 90%);
  padding:8px 0 10px;
}

.top-row{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:8px;
}

.logo-circle{
  width:38px; height:38px;
  border-radius:50%;
  border:2px solid var(--accent-grey);
  display:flex; align-items:center; justify-content:center;
  overflow:hidden;
}

.logo-gear{
  width:22px; height:22px;
  border-radius:50%;
  border:2px solid var(--accent-grey);
  position:relative;
}
.logo-gear.spinning::before{
  content:"";
  position:absolute;
  inset:4px;
  border-radius:50%;
  border:2px solid var(--accent-green);
  border-right-color:transparent;
  border-bottom-color:transparent;
  animation:logo-spin 2s linear infinite;
}
@keyframes logo-spin{from{transform:rotate(0);}to{transform:rotate(360deg);}}

/* ===== TITLE ===== */
.title-block{display:flex; flex-direction:column; gap:2px;}
.title-main{font-size:1.2rem; font-weight:700;}
.title-sub{font-size:.72rem; color:var(--text-soft);}

/* ===== LANGUAGE SWITCH ===== */
.lang-switch{
  margin-left:auto;
  display:flex;
  align-items:center;
  gap:4px;
}
.lang-btn{
  padding:4px 8px;
  font-size:.72rem;
  border-radius:999px;
  border:1px solid var(--border-soft);
  background:#031226;
  color:var(--text-soft);
  cursor:pointer;
}
.lang-btn.active{
  background:var(--accent-blue);
  color:#fff;
}

/* ===== TIMER CARD ===== */
.timer-card{
  background:var(--bg-card);
  padding:6px 10px 10px;
  border-radius:16px;
  border:1px solid var(--border-soft);
  box-shadow:0 8px 18px rgba(0,0,0,.45);
}
.timer-display{
  text-align:center;
  font-size:2.8rem;
  letter-spacing:.08em;
  font-weight:600;
}

/* ===== SAMPLE INFO ===== */
.sample-info{
  font-size:.78rem;
  padding:4px 8px;
  border-radius:10px;
  margin-bottom:6px;
  border:1px solid transparent;
}
.sample-neutral{background:#ffffff05; border-color:#ffffff10; color:var(--text-soft);}
.sample-good{background:#00c85322; border-color:#00c853aa; color:#d0f8ce;}
.sample-warn{background:#ffb30022; border-color:#ffb300aa; color:#ffe082;}
.sample-bad{background:#ff174422; border-color:#ff1744aa; color:#ffab91;}

/* ===== BUTTONS ===== */
.btn-row-main{display:flex; gap:10px;}
.btn{
  flex:1;
  padding:10px 12px;
  font-size:.9rem;
  font-weight:700;
  border:none;
  border-radius:14px;
  cursor:pointer;
  color:#fff;
}
.btn-start{background:var(--btn-green);}
.btn-lap{background:var(--btn-orange);}
<script>
/* ======================================================
   TAKTLAB – PREMIUM VERSION JS
   Autor: Roberto González (Consultor)
   ====================================================== */

(function(){
/* ==============================
   DOM Elements
   ============================== */
const display = document.getElementById('display');
const btnStart = document.getElementById('btnStart');
const btnLap = document.getElementById('btnLap');
const timerCard = document.getElementById('timerCard');
const logoGear = document.getElementById('logoGear');
const sampleInfoDiv = document.getElementById('sampleInfo');

const processInput = document.getElementById('processName');
const modeSelect   = document.getElementById('mode');
const effInput     = document.getElementById('efficiency');
const pcdInput     = document.getElementById('contractPcd');
const hInput       = document.getElementById('hoursPerDay');
const dInput       = document.getElementById('daysPerWeek');
const capViewSel   = document.getElementById('capView');

const ringT1 = document.getElementById('ringT1');
const ringT2 = document.getElementById('ringT2');
const t1Indicator = document.getElementById('t1Indicator');
const t2Indicator = document.getElementById('t2Indicator');

const overviewBody   = document.getElementById('overviewBody');
const statsBody      = document.getElementById('statsBody');
const contractSummary= document.getElementById('contractSummary');
const statsFocusDiv  = document.getElementById('statsFocus');
const capacitySnapshotDiv = document.getElementById('capacitySnapshot');

const dataBody    = document.getElementById('dataBody');
const btnCopyAll  = document.getElementById('btnCopyAll');
const btnCopySum  = document.getElementById('btnCopySummary');
const btnAddMan   = document.getElementById('btnAddManualLap');
const btnReset    = document.getElementById('btnReset');

const chartSelect      = document.getElementById('chartProcessSelect');
const timeSeriesCanvas = document.getElementById('timeSeriesCanvas');
const histCanvas       = document.getElementById('histCanvas');

const langButtons = document.querySelectorAll('.lang-btn');

/* ===================================================
   i18n Translator (PREMIUM VERSION)
   =================================================== */

const i18n = {
  en: {
    "sample.none":"No samples yet. Start capturing laps.",
    "sample.few":"Samples: {n}/{req} – need ≥3 before error estimation.",
    "sample.bad":"Samples: {n}/{req} · Est. error: ±{err}% – sample too small.",
    "sample.warn":"Samples: {n}/{req} · Est. error: ±{err}% – almost enough.",
    "sample.good":"Samples: {n}/{req} · Est. error: ±{err}% – solid sample.",

    "snapshot.current":"1) Current capacity @Eff ({eff}%): {val} units/{view}",
    "snapshot.potential":"2) Potential (P10): {val} units/{view} {gain}",

    // Stats Focus (fusionado dentro de Decision View)
    "focus.title":"Statistical Focus",
    "focus.sample.bad":"Sample size {n}/{req} → too low, continue measuring.",
    "focus.sample.warn":"Sample size {n}/{req} → almost enough.",
    "focus.sample.good":"Sample size {n}/{req} → enough for decision.",
    "focus.var.low":"Low variation (σ={std}s, CV={cv}%). Stable process.",
    "focus.var.med":"Moderate variation (σ={std}s, CV={cv}%).",
    "focus.var.high":"High variation (σ={std}s, CV={cv}%). Unstable timings.",
    "focus.norm.good":"Mean≈Median → close to normal.",
    "focus.norm.bad":"Mean far from Median → non-normal, check method/outliers.",
    "focus.cap.none":"No contract loaded → capability not evaluated.",
    "focus.cap.bad":"Not capable (Cp={cp}, Cpk={cpk}) → bottleneck.",
    "focus.cap.warn":"Borderline (Cp={cp}, Cpk={cpk}) → reduce variation.",
    "focus.cap.good":"Capable (Cp={cp}, Cpk={cpk}).",

    // Footer
    "footer.note":"Created by Roberto González – Contact: hzaelglez@gmail.com"
  },

  es: {
    "sample.none":"Sin muestras aún. Comienza a capturar vueltas.",
    "sample.few":"Muestras: {n}/{req} – se requieren ≥3 para estimar error.",
    "sample.bad":"Muestras: {n}/{req} · Error est.: ±{err}% – muestra insuficiente.",
    "sample.warn":"Muestras: {n}/{req} · Error est.: ±{err}% – casi suficiente.",
    "sample.good":"Muestras: {n}/{req} · Error est.: ±{err}% – muestra sólida.",

    "snapshot.current":"1) Capacidad actual @Eff ({eff}%): {val} pzs/{view}",
    "snapshot.potential":"2) Potencial (P10): {val} pzs/{view} {gain}",

    "focus.title":"Enfoque Estadístico",
    "focus.sample.bad":"Tamaño {n}/{req} → muy bajo, seguir midiendo.",
    "focus.sample.warn":"Tamaño {n}/{req} → casi suficiente.",
    "focus.sample.good":"Tamaño {n}/{req} → suficiente para decidir.",
    "focus.var.low":"Baja variación (σ={std}s, CV={cv}%). Proceso estable.",
    "focus.var.med":"Variación moderada (σ={std}s, CV={cv}%).",
    "focus.var.high":"Alta variación (σ={std}s, CV={cv}%). Inestable.",
    "focus.norm.good":"Media≈Mediana → distribución cercana a normal.",
    "focus.norm.bad":"Media alejada de mediana → no normal, revisar método/outliers.",
    "focus.cap.none":"Sin contrato → no se evalúa capacidad.",
    "focus.cap.bad":"No capaz (Cp={cp}, Cpk={cpk}) → cuello de botella.",
    "focus.cap.warn":"En límite (Cp={cp}, Cpk={cpk}) → reducir variación.",
    "focus.cap.good":"Capaz (Cp={cp}, Cpk={cpk}).",

    "footer.note":"Creado por Roberto González – Contacto: hzaelglez@gmail.com"
  }
};

let currentLang = localStorage.getItem("taktLang") || "en";

/* ======= Helper para traducir ======= */
function tr(key, vars={}){
  let txt = i18n[currentLang][key] || i18n.en[key] || key;
  for(const k in vars){
    txt = txt.replace(`{${k}}`, vars[k]);
  }
  return txt;
}

/* ===================================================
   ESTADO DEL TIMER
   =================================================== */
let running = false;
let startTime = 0;
let elapsed = 0;
let timerId = null;

let laps = [];     // Todas las vueltas
let nextId = 1;
let pendingT1 = null;

/* ===================================================
   UTILIDADES
   =================================================== */

function pad2(n){return n<10?'0'+n:n;}
function fmt(ms){
  const total=Math.max(ms,0);
  const m=Math.floor(total/60000);
  const s=Math.floor((total%60000)/1000);
  const c=Math.floor((total%1000)/10);
  return `${pad2(m)}:${pad2(s)}.${pad2(c)}`;
}
function fmtS(s){
  if(!isFinite(s)) return "-";
  return (Math.round(s*10)/10).toFixed(1);
}

/* ===================================================
   DISPLAY
   =================================================== */
function updateDisplay(){
  display.textContent = fmt(elapsed);
}

/* ===================================================
   LÓGICA DEL TIMER
   =================================================== */
function start(){
  if(running) return;
  running = true;
  startTime = performance.now() - elapsed;
  timerId = requestAnimationFrame(tick);
  btnStart.textContent = (currentLang==="es"?"Pausar":"Pause");
}

function pause(){
  if(!running) return;
  running = false;
  cancelAnimationFrame(timerId);
  timerId = null;
  btnStart.textContent = (currentLang==="es"?"Iniciar":"Start");
}

btnStart.onclick = ()=> running ? pause() : start();

/* ===================================================
   TICK
   =================================================== */
function tick(){
  const now = performance.now();
  elapsed = now - startTime;
  updateDisplay();

  let sec = elapsed/1000;

  if(running){
    if(modeSelect.value==="MLD"){
      if(pendingT1===null) t1Indicator.textContent = fmtS(sec)+" s";
      else t2Indicator.textContent = fmtS(sec)+" s";
    }else{
      t1Indicator.textContent = fmtS(sec)+" s";
    }
  }

  timerId = requestAnimationFrame(tick);
}

/* ===================================================
   ADD LAP
   =================================================== */
function ensureProcessMode(){
  let p = processInput.value.trim();
  if(!p){
    p="Process 1";
    processInput.value=p;
  }
  return {proc:p, mode:modeSelect.value};
}

function addLap(manual){
  const {proc,mode} = ensureProcessMode();

  if(manual){
    laps.push({
      id:nextId++, process:proc, mode,
      status:"", note:"",
      t1:manual.t1, t2:manual.t2,
      total:manual.total
    });
    renderAll();
    return;
  }

  let sec = elapsed/1000;

  if(mode==="CT"){
    laps.push({id:nextId++, process:proc, mode,
      status:"", note:"",
      t1:sec, t2:0, total:sec
    });
    // reset
    pendingT1=null;
    elapsed=0; startTime=performance.now();
    t1Indicator.textContent="0.0 s";
    t2Indicator.textContent="0.0 s";
    renderAll();
    return;
  }

  // MLD
  if(pendingT1===null){
    pendingT1 = sec;
    t1Indicator.textContent = fmtS(sec)+" s";
    elapsed=0; startTime=performance.now();
    return;
  }else{
    const t1 = pendingT1;
    const t2 = sec;
    laps.push({id:nextId++, process:proc, mode,
      status:"", note:"",
      t1,t2,total:t1+t2
    });
    pendingT1=null;
    t1Indicator.textContent="0.0 s";
    t2Indicator.textContent="0.0 s";
    elapsed=0; startTime=performance.now();
    renderAll();
  }
}

btnLap.onclick = ()=> addLap();

/* ===================================================
   SAMPLE SIZE + ERROR ESTIMATION (PREMIUM)
   =================================================== */

function calcStats(arr){
  if(!arr.length) return null;
  const vals = arr.map(x=>x.total).sort((a,b)=>a-b);
  const n = vals.length;
  const mean = vals.reduce((s,v)=>s+v,0)/n;
  const med  = (n%2?vals[(n-1)/2]:(vals[n/2-1]+vals[n/2])/2);
  const min = vals[0];
  const max = vals[n-1];
  const variance = vals.reduce((s,v)=>s+(v-mean)**2,0)/(n-1||1);
  const std = Math.sqrt(variance);
  const p10 = percentile(vals,0.10);
  const p90 = percentile(vals,0.90);
  return {n,vals,mean,median:med,min,max,std,p10,p90};
}

function percentile(v,p){
  const n=v.length;
  if(n===0) return NaN;
  if(n===1) return v[0];
  const idx=(n-1)*p;
  const lo=Math.floor(idx);
  const hi=Math.ceil(idx);
  if(lo===hi) return v[lo];
  return v[lo] + (v[hi]-v[lo])*(idx-lo);
}

/* ===================================================
   GROUP BY
   =================================================== */
function groupByProcess(){
  const m=new Map();
  laps.forEach(l=>{
    const key=l.process+"||"+l.mode;
    if(!m.has(key)) m.set(key,[]);
    m.get(key).push(l);
  });
  return m;
}

/* ===================================================
   SAMPLE INFO UNDER TIMER
   =================================================== */
function updateSampleInfo(){
  const groups = groupByProcess();
  const {proc,mode} = ensureProcessMode();
  const key = proc+"||"+mode;
  const arr = groups.get(key)||[];

  if(arr.length===0){
    sampleInfoDiv.className="sample-info sample-neutral";
    sampleInfoDiv.textContent=tr("sample.none");
    return;
  }

  if(arr.length<3){
    sampleInfoDiv.className="sample-info sample-neutral";
    sampleInfoDiv.textContent = tr("sample.few",{n:arr.length,req:3});
    return;
  }

  const st = calcStats(arr);
  const cv = st.std/st.mean;
  const Z = 1.96;
  const targetErr = 0.03; // ±3%
  const reqN = Math.ceil(((Z*cv)/targetErr)**2);

  const n = arr.length;
  const e = (Z*cv/Math.sqrt(n))*100;
  const eTxt = e.toFixed(1);

  let cls="sample-warn", msg="";
  if(n < 0.6*reqN){
    cls="sample-bad"; msg=tr("sample.bad",{n,req:reqN,err:eTxt});
  }else if(n < 0.9*reqN){
    cls="sample-warn"; msg=tr("sample.warn",{n,req:reqN,err:eTxt});
  }else{
    cls="sample-good"; msg=tr("sample.good",{n,req:reqN,err:eTxt});
  }

  sampleInfoDiv.className="sample-info "+cls;
  sampleInfoDiv.textContent = msg;
}

/* ========= FIN DE PARTE 2 ========= */
</script>
<script>
/* =====================================================
   PARTE 3 – RENDER, SNAPSHOT, CAPACITY, CHARTS, SUMMARY
   ===================================================== */

/* =====================================================
   CAPACITY CALCULATIONS
   ===================================================== */
function capacityFromCT(ct){
  if(!ct || ct<=0) return 0;
  return 3600/ct;
}

function applyEfficiency(cap){
  const eff=parseFloat(effInput.value)||0;
  return cap*(eff/100);
}

function convertView(val){
  const view=capViewSel.value;
  const h=+hInput.value||8;
  const d=+dInput.value||5;
  if(view==="hour") return val;
  if(view==="day")  return val*h;
  return val*h*d; // week
}

function fmtUnits(u){
  return Math.round(u).toString(); // sin decimales
}

/* =====================================================
   CONTRACT VS CAPACITY SUMMARY
   ===================================================== */
function renderContractSummary(snap){
  const contract = parseFloat(pcdInput.value)||0;
  if(!contract){
    contractSummary.textContent="";
    return;
  }

  const curr = snap.currentUnits;
  const pct = ((curr/contract)*100).toFixed(1);

  let color = (pct<85)? "red" : (pct<100?"amber":"green");

  contractSummary.innerHTML = `
    <div style="margin-top:8px; font-size:.85rem;">
      <b>${currentLang==="es"?"Contrato":"Contract"}:</b> ${fmtUnits(contract)}  
      <br>
      <b>${currentLang==="es"?"Actual":"Actual"}:</b> 
      <span style="color:${color==="red"?"#ff1744":(color==="amber"?"#ffb300":"#00c853")}">
        ${fmtUnits(curr)} ${currentLang==="es"?"pzs":"units"}
      </span>
      (${pct}%)
    </div>
  `;
}

/* =====================================================
   SNAPSHOT + STATS FOCUS (FUSIONADOS)
   ===================================================== */
function renderDecisionView(st){
  if(!st || !st.n){
    capacitySnapshotDiv.innerHTML = 
      `<div style="font-size:.85rem; color:var(--text-muted);">
        No samples.
      </div>`;
    return;
  }

  const eff = parseFloat(effInput.value)||0;

  // current capacity
  const currCapHr  = capacityFromCT(st.median);
  const currEffHr  = applyEfficiency(currCapHr);
  const currUnits  = convertView(currEffHr);

  // potential capacity
  const potCapHr   = capacityFromCT(st.p10);
  const potEffHr   = applyEfficiency(potCapHr);
  const potUnits   = convertView(potEffHr);

  const gain = potUnits - currUnits;
  const gainTxt = gain>0 ? 
        `<span style="color:#00c853;">(+${fmtUnits(gain)})</span>` : "";

  const viewName = (capViewSel.value==="hour"?
                   (currentLang==="es"?"hora":"hour"):
                   capViewSel.value==="day"?
                   (currentLang==="es"?"día":"day"):
                   (currentLang==="es"?"semana":"week"));

  let snapHtml = `
    <div style="font-size:.88rem; margin-bottom:6px;">
      <b>${tr("snapshot.current",{eff, val:fmtUnits(currUnits), view:viewName})}</b>
      <br>
      <b>${tr("snapshot.potential",{val:fmtUnits(potUnits), view:viewName, gain:gainTxt})}</b>
    </div>
  `;

  /* ------- STATS FOCUS INTEGRADO ------- */
  let focus = `<div style="font-size:.80rem; margin-top:6px;">
      <b>${tr("focus.title")}:</b><br>
  `;

  // sample size
  const cv = st.std/st.mean;
  const Z=1.96, targetErr=0.03;
  const reqN = Math.ceil(((Z*cv)/targetErr)**2);

  if(st.n < 0.6*reqN){
    focus += "- " + tr("focus.sample.bad",{n:st.n,req:reqN}) + "<br>";
  }else if(st.n < reqN){
    focus += "- " + tr("focus.sample.warn",{n:st.n,req:reqN}) + "<br>";
  }else{
    focus += "- " + tr("focus.sample.good",{n:st.n,req:reqN}) + "<br>";
  }

  // variation
  const cvPct = (cv*100).toFixed(1);
  if(cv<0.1){
    focus += "- " + tr("focus.var.low",{std:fmtS(st.std),cv:cvPct}) + "<br>";
  }else if(cv<0.2){
    focus += "- " + tr("focus.var.med",{std:fmtS(st.std),cv:cvPct}) + "<br>";
  }else{
    focus += "- " + tr("focus.var.high",{std:fmtS(st.std),cv:cvPct}) + "<br>";
  }

  // normality indicator
  const diff = Math.abs(st.mean-st.median);
  if(diff < st.std*0.2){
    focus += "- " + tr("focus.norm.good") + "<br>";
  }else{
    focus += "- " + tr("focus.norm.bad") + "<br>";
  }

  // capability
  const contractCT = targetCTfromContract();
  if(!contractCT){
    focus += "- " + tr("focus.cap.none") + "<br>";
  }else{
    const cp  = (st.max - st.min) ? (contractCT - st.min)/(6*st.std) : 0;
    const cpk = (contractCT - st.median)/(3*st.std);
    if(cpk<1){
      focus += "- " + tr("focus.cap.bad",{cp:cp.toFixed(2), cpk:cpk.toFixed(2)}) + "<br>";
    }else if(cpk<1.33){
      focus += "- " + tr("focus.cap.warn",{cp:cp.toFixed(2), cpk:cpk.toFixed(2)}) + "<br>";
    }else{
      focus += "- " + tr("focus.cap.good",{cp:cp.toFixed(2), cpk:cpk.toFixed(2)}) + "<br>";
    }
  }

  focus += "</div>";

  capacitySnapshotDiv.innerHTML = snapHtml + focus;

  renderContractSummary({currentUnits:currUnits});
}

function targetCTfromContract(){
  const contract = parseFloat(pcdInput.value)||0;
  if(!contract) return null;
  const h=+hInput.value||8;
  const d=+dInput.value||5;
  const view=capViewSel.value;

  let perHr;
  if(view==="hour") perHr=contract;
  else if(view==="day") perHr=contract/h;
  else perHr=contract/(h*d);
  
  return perHr>0 ? 3600/perHr : null;
}

/* =====================================================
   RENDER OVERVIEW TABLE
   ===================================================== */
function renderOverview(groups){
  overviewBody.innerHTML="";
  groups.forEach((arr,key)=>{
    const st=calcStats(arr);
    if(!st) return;

    // current
    const curr = convertView(applyEfficiency(capacityFromCT(st.median)));
    // potential
    const pot  = convertView(applyEfficiency(capacityFromCT(st.p10)));
    // error
    const cv=st.std/st.mean; const Z=1.96;
    const n=st.n;
    const e= (Z*cv/Math.sqrt(n))*100;

    const row=document.createElement("tr");
    const [proc,mode]=key.split("||");
    row.innerHTML=`
      <td>${proc}</td>
      <td>${mode}</td>
      <td>${st.n}</td>
      <td>${fmtS(st.mean)}</td>
      <td>${fmtS(st.median)}</td>
      <td>${fmtS(st.p10)}</td>
      <td>${fmtS(st.p90)}</td>
      <td>${fmtUnits(curr)}</td>
      <td>${fmtUnits(pot)}</td>
      <td>${e.toFixed(1)}%</td>
    `;
    overviewBody.appendChild(row);
  });
}

/* =====================================================
   RENDER RAW DATA
   ===================================================== */
function renderData(){
  dataBody.innerHTML="";
  laps.forEach(l=>{
    const row=document.createElement("tr");
    let noteHtml=l.note? `<span style="color:#00c853;">${l.note}</span>`:"";
    row.innerHTML=`
      <td>${l.id}</td>
      <td>${l.process}</td>
      <td>${l.mode}</td>
      <td>${fmtS(l.t1)}</td>
      <td>${fmtS(l.t2)}</td>
      <td>${fmtS(l.total)}</td>
      <td><input value="${l.status}" style="width:50px;"></td>
      <td><input value="${l.note}" style="width:110px;"></td>
      <td><button style="background:#b71c1c; color:#fff;" onclick="deleteLap(${l.id})">X</button></td>
    `;
    dataBody.appendChild(row);
  });
}

window.deleteLap=function(id){
  laps=laps.filter(l=>l.id!==id);
  renderAll();
};

/* =====================================================
   RENDER STATS DETAIL
   ===================================================== */
function renderStatsDetail(groups){
  statsBody.innerHTML="";
  groups.forEach((arr,key)=>{
    const st=calcStats(arr);
    if(!st) return;
    const [proc,mode]=key.split("||");

    const row=document.createElement("tr");
    row.innerHTML=`
      <td>${proc}</td>
      <td>${mode}</td>
      <td>${st.n}</td>
      <td>${fmtS(st.mean)}</td>
      <td>${fmtS(st.median)}</td>
      <td>${fmtS(st.std)}</td>
      <td>${fmtS(st.min)}</td>
      <td>${fmtS(st.max)}</td>
      <td>${fmtS(st.p10)}</td>
      <td>${fmtS(st.p90)}</td>
    `;
    statsBody.appendChild(row);
  });
}

/* =====================================================
   CHARTS (Time Series + Histogram)
   ===================================================== */
function renderCharts(groups){
  const proc=processInput.value.trim();
  const mode=modeSelect.value;
  const key=proc+"||"+mode;
  const arr=groups.get(key)||[];
  
  const ctx1=timeSeriesCanvas.getContext("2d");
  const ctx2=histCanvas.getContext("2d");
  ctx1.clearRect(0,0,600,200);
  ctx2.clearRect(0,0,600,200);

  if(arr.length<2) return;

  // time series
  ctx1.strokeStyle="#29b6f6";
  ctx1.lineWidth=2;
  ctx1.beginPath();
  arr.forEach((l,i)=>{
    const x=i*(600/arr.length);
    const y=200 - (l.total/Math.max(...arr.map(z=>z.total))) * 180;
    if(i===0) ctx1.moveTo(x,y);
    else ctx1.lineTo(x,y);
  });
  ctx1.stroke();

  // histogram
  const vals=arr.map(l=>l.total);
  const min=Math.min(...vals);
  const max=Math.max(...vals);
  const bins=10;
  const bw=(max-min)/bins;
  let freq=new Array(bins).fill(0);
  vals.forEach(v=>{
    let b=Math.floor((v-min)/bw);
    if(b===bins) b--;
    freq[b]++;
  });
  const maxF=Math.max(...freq);

  ctx2.fillStyle="#29b6f6";
  for(let i=0;i<bins;i++){
    const barH = (freq[i]/maxF)*180;
    ctx2.fillRect(i*(600/bins), 200-barH, (600/bins)-4, barH);
  }
}

/* =====================================================
   COPY SUMMARY PREMIUM
   ===================================================== */
function buildSummary(){
  const {proc,mode} = ensureProcessMode();
  const groups=groupByProcess();
  const arr=groups.get(proc+"||"+mode)||[];
  if(arr.length===0) 
    return currentLang==="es"?"Sin datos.":"No data.";

  const st=calcStats(arr);

  // snapshot calc
  const eff=parseFloat(effInput.value)||0;
  const curr = convertView(applyEfficiency(capacityFromCT(st.median)));
  const pot  = convertView(applyEfficiency(capacityFromCT(st.p10)));
  const gain = pot - curr;

  const viewName=(capViewSel.value==="hour"?
    (currentLang==="es"?"hora":"hour"):
    capViewSel.value==="day"?
    (currentLang==="es"?"día":"day"):
    (currentLang==="es"?"semana":"week"));

return `
=== TAKTLAB – SUMMARY ===
Process: ${proc}
Mode: ${mode}

1) ${tr("snapshot.current",{eff,val:fmtUnits(curr),view:viewName})}
2) ${tr("snapshot.potential",{val:fmtUnits(pot),view:viewName,gain:(gain>0?`(+${fmtUnits(gain)})`:"")})}

N=${st.n}, Mean=${fmtS(st.mean)}s, Median=${fmtS(st.median)}s,
Std=${fmtS(st.std)}s, P10=${fmtS(st.p10)}s, P90=${fmtS(st.p90)}s

Variation CV=${((st.std/st.mean)*100).toFixed(1)}%

${currentLang==="es"?
"Generado con TaktLab – Contacto: hzaelglez@gmail.com":
"Generated with TaktLab – Contact: hzaelglez@gmail.com"
}
`;
}

/* =====================================================
   MAIN RENDER
   ===================================================== */
function renderAll(){
  updateSampleInfo();
  const groups=groupByProcess();

  // current group for snapshot
  const {proc,mode}=ensureProcessMode();
  const arr=groups.get(proc+"||"+mode)||[];
  const st=calcStats(arr);
  renderDecisionView(st);

  renderOverview(groups);
  renderStatsDetail(groups);
  renderData();
  renderCharts(groups);
}

renderAll();

/* =====================================================
   EVENTS
   ===================================================== */
btnReset.onclick=()=>{
  elapsed=0;
  startTime=performance.now();
  running=false;
  cancelAnimationFrame(timerId);
  timerId=null;
  pendingT1=null;
  t1Indicator.textContent="0.0 s";
  t2Indicator.textContent="0.0 s";
  display.textContent="00:00.00";
};

btnCopyAll.onclick=()=>{
  const text=JSON.stringify(laps,null,2);
  navigator.clipboard.writeText(text);
};

btnCopySum.onclick=()=>{
  navigator.clipboard.writeText(buildSummary());
};

btnAddMan.onclick=()=>{
  const t=parseFloat(prompt(currentLang==="es"?"Ingresa total (s)":"Enter total (s)"));
  if(!t) return;
  addLap({t1:t, t2:0, total:t});
};

[processInput,modeSelect,effInput,pcdInput,hInput,dInput,capViewSel]
.forEach(inp=> inp.oninput=()=>renderAll());

/* =====================================================
   LANGUAGE SWITCH
   ===================================================== */
langButtons.forEach(btn=>{
  btn.onclick=()=>{
    const lang=btn.dataset.lang;
    currentLang=lang;
    localStorage.setItem("taktLang",lang);
    langButtons.forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    applyTranslations();
    renderAll();
  };
});

function applyTranslations(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key=el.dataset.i18n;
    el.textContent = tr(key);
  });
}

// set initial
langButtons.forEach(b=>{
  if(b.dataset.lang===currentLang) b.classList.add("active");
});
applyTranslations();

/* =====================================================
   FOOTER (contacto)
   ===================================================== */
document.getElementById("footerNote").innerHTML = tr("footer.note");

})(); // END IIFE
</script>
