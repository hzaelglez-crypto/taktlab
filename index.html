<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TaktLab – Cycle Time & Capacity Analyzer</title>
<style>
  :root{
    --bg-main:#07152b;
    --bg-card:#0b1f3a;
    --bg-card-soft:#0f2544;
    --accent-green:#00c853;
    --accent-amber:#ffb300;
    --accent-red:#ff1744;
    --accent-blue:#29b6f6;
    --accent-grey:#cfd8dc;
    --text-main:#ffffff;
    --text-soft:#c5cae9;
    --text-muted:#90a4ae;
    --border-soft:#1c3357;
    --btn-green:#00c853;
    --btn-orange:#ff9100;
    --btn-grey:#455a64;
    --badge-green:#004d40;
    --badge-red:#b71c1c;
    --badge-amber:#ff8f00;
  }

  *{box-sizing:border-box;}

  body{
    margin:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:linear-gradient(180deg,#020b1a 0%,#07152b 40%,#020b1a 100%);
    color:var(--text-main);
  }

  .page{
    max-width:1100px;
    margin:0 auto;
    padding:12px 10px 40px;
  }

  /* ===== Sticky timer bar ===== */
  .sticky-timer-bar{
    position:sticky;
    top:0;
    z-index:100;
    background:linear-gradient(180deg,#020b1a 0%,#07152b 90%);
    padding:8px 0 10px;
  }

  .top-row{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:8px;
  }

  .logo-circle{
    width:38px;
    height:38px;
    border-radius:50%;
    border:2px solid var(--accent-grey);
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    overflow:hidden;
  }
  .logo-gear{
    width:22px;
    height:22px;
    border-radius:50%;
    border:2px solid var(--accent-grey);
    position:relative;
  }
  .logo-gear::before{
    content:"";
    position:absolute;
    inset:4px;
    border-radius:50%;
    border:2px solid var(--accent-green);
    border-right-color:transparent;
    border-bottom-color:transparent;
    transform-origin:50% 50%;
    animation:logo-spin 2s linear infinite;
  }
  @keyframes logo-spin{
    from{transform:rotate(0deg);}
    to{transform:rotate(360deg);}
  }

  .title-block{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .title-main{
    font-size:1.2rem;
    font-weight:700;
    letter-spacing:.03em;
  }
  .title-sub{
    font-size:.72rem;
    color:var(--text-soft);
  }

  /* timer panel */
  .timer-card{
    background:var(--bg-card);
    border-radius:18px;
    border:1px solid var(--border-soft);
    padding:6px 10px 12px;
    box-shadow:0 8px 18px rgba(0,0,0,.45);
  }

  .timer-display{
    text-align:center;
    font-size:2.8rem;
    font-weight:600;
    letter-spacing:.08em;
    padding:4px 4px 10px;
  }

  .btn-row-main{
    display:flex;
    gap:10px;
    margin-bottom:4px;
  }
  .btn{
    border:none;
    border-radius:16px;
    padding:10px 12px;
    font-size:.9rem;
    font-weight:600;
    cursor:pointer;
    color:#fff;
    box-shadow:0 4px 10px rgba(0,0,0,.4);
    flex:1;
    transition:transform .04s ease, box-shadow .04s ease, background .15s;
    touch-action:manipulation;
  }
  .btn:active{
    transform:translateY(1px);
    box-shadow:0 1px 4px rgba(0,0,0,.5);
  }
  .btn-start{background:var(--btn-green);}
  .btn-lap{background:var(--btn-orange);}
  .btn-secondary{background:var(--btn-grey); flex:0 0 auto;}

  .mode-row{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
    font-size:.78rem;
    color:var(--text-soft);
  }
  .mode-row label{font-weight:500;}
  .mode-row select,
  .mode-row input{
    background:#020b1a;
    border-radius:8px;
    border:1px solid var(--border-soft);
    padding:4px 8px;
    color:var(--text-soft);
    font-size:.78rem;
    min-width:70px;
  }
  .mode-row input[type="number"]{
    width:70px;
  }

  /* T1/T2 mini indicators */
  .mini-t12-wrapper{
    display:flex;
    gap:8px;
    margin-top:6px;
  }
  .mini-t12{
    flex:1;
    background:#020b1a;
    border-radius:14px;
    border:1px solid var(--border-soft);
    padding:6px 10px;
    display:flex;
    align-items:center;
    gap:8px;
    min-height:56px;
  }
  .mini-ring{
    width:36px;
    height:36px;
    border-radius:50%;
    border:3px solid rgba(255,255,255,.08);
    position:relative;
    overflow:hidden;
  }
  .mini-ring::before{
    content:"";
    position:absolute;
    inset:-3px;
    border-radius:50%;
    border:3px solid transparent;
    border-top-color:var(--accent-green);
    border-right-color:var(--accent-green);
    transform-origin:50% 50%;
    animation:ring-spin 1.2s linear infinite;
    opacity:.1;
  }
  .mini-ring.paused::before{
    animation-play-state:paused;
    opacity:.35;
  }
  @keyframes ring-spin{
    from{transform:rotate(0);}
    to{transform:rotate(360deg);}
  }
  .mini-label{font-size:.72rem;color:var(--text-soft);}
  .mini-value{font-size:.95rem;font-weight:600;}

  /* layout for rest of page */
  .content-section{
    margin-top:10px;
  }

  .section-card{
    background:var(--bg-card);
    border-radius:18px;
    border:1px solid var(--border-soft);
    padding:10px 10px 12px;
    margin-bottom:10px;
  }
  .section-title{
    font-size:.9rem;
    font-weight:600;
    margin-bottom:6px;
  }

  table{
    width:100%;
    border-collapse:collapse;
    font-size:.75rem;
  }
  th,td{
    padding:4px 6px;
    text-align:right;
    border-bottom:1px solid rgba(255,255,255,.04);
  }
  th:first-child,td:first-child{text-align:left;}
  th{
    color:var(--text-soft);
    font-weight:600;
    background:rgba(255,255,255,.02);
    position:sticky;
    top:0;
    z-index:5;
  }
  tbody tr:nth-child(even){
    background:rgba(255,255,255,.02);
  }

  .badge{
    display:inline-block;
    padding:2px 6px;
    border-radius:999px;
    font-size:.68rem;
    border:1px solid transparent;
  }
  .badge-good{background:var(--badge-green);border-color:#00e676;}
  .badge-warn{background:var(--badge-amber);border-color:#ffe082;}
  .badge-bad{background:var(--badge-red);border-color:#ff8a80;}

  .summary-row-top{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:flex-end;
  }
  .summary-row-top .field{
    display:flex;
    flex-direction:column;
    gap:2px;
    font-size:.72rem;
  }
  .summary-row-top .field input,
  .summary-row-top .field select{
    background:#020b1a;
    border-radius:8px;
    border:1px solid var(--border-soft);
    padding:4px 8px;
    color:var(--text-soft);
    font-size:.75rem;
    min-width:70px;
  }

  .inline-badges{
    display:flex;
    flex-wrap:wrap;
    gap:4px;
    margin-top:4px;
  }

  .btn-row-secondary{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin:6px 0 4px;
  }
  .btn-small{
    padding:6px 10px;
    border-radius:10px;
    font-size:.75rem;
    flex:0 0 auto;
    background:var(--bg-card-soft);
    color:var(--text-soft);
    border:1px solid var(--border-soft);
    cursor:pointer;
  }
  .btn-small:active{transform:translateY(1px);}

  .stats-focus{
    font-size:.74rem;
    line-height:1.3;
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .focus-line{
    padding:3px 6px;
    border-radius:8px;
  }
  .focus-good{background:rgba(0,200,83,.12);border:1px solid rgba(0,200,83,.6);}
  .focus-warn{background:rgba(255,193,7,.08);border:1px solid rgba(255,193,7,.6);}
  .focus-bad{background:rgba(244,67,54,.12);border:1px solid rgba(244,67,54,.7);}

  .footer-note{
    margin-top:10px;
    font-size:.65rem;
    color:var(--text-muted);
    text-align:right;
  }

  .flash{
    animation:flash-bg .12s ease-out;
  }
  @keyframes flash-bg{
    from{background:rgba(255,255,255,.18);}
    to{background:transparent;}
  }

  @media (max-width:600px){
    .timer-display{font-size:2.2rem;}
    .btn-row-main{gap:6px;}
    .btn{font-size:.9rem;border-radius:14px;}
  }
</style>
</head>
<body>
<div class="page">

  <!-- STICKY TIMER BAR -->
  <div class="sticky-timer-bar">
    <div class="top-row">
      <div class="logo-circle">
        <div class="logo-gear"></div>
      </div>
      <div class="title-block">
        <div class="title-main">TaktLab</div>
        <div class="title-sub">Cycle Time &amp; Capacity Analyzer</div>
      </div>
    </div>

    <div class="timer-card" id="timerCard">
      <div class="timer-display" id="display">00:00.00</div>
      <div class="btn-row-main">
        <button class="btn btn-start" id="btnStart">Start</button>
        <button class="btn btn-lap" id="btnLap">LAP</button>
      </div>

      <div class="mode-row">
        <div>
          <label for="processName">Process</label><br/>
          <input id="processName" type="text" placeholder="e.g. Op 30-1" />
        </div>
        <div>
          <label for="mode">Mode</label><br/>
          <select id="mode">
            <option value="CT">Cycle Time (CT)</option>
            <option value="MLD">Machine &amp; Load/Unload</option>
          </select>
        </div>
        <div>
          <label for="efficiency">Efficiency %</label><br/>
          <input id="efficiency" type="number" value="100" min="10" max="100" step="1" />
        </div>
        <div>
          <label for="contractPcd">Contract Cap (pcs/day)</label><br/>
          <input id="contractPcd" type="number" min="0" step="1" />
        </div>
        <div>
          <label for="hoursPerDay">Hours / Day</label><br/>
          <input id="hoursPerDay" type="number" value="8" min="1" max="24" step="0.5" />
        </div>
        <div>
          <label for="daysPerWeek">Days / Week</label><br/>
          <input id="daysPerWeek" type="number" value="5" min="1" max="7" step="1" />
        </div>
        <div>
          <label for="capView">Capacity View</label><br/>
          <select id="capView">
            <option value="hour">per Hour</option>
            <option value="day">per Day</option>
            <option value="week">per Week</option>
          </select>
        </div>
      </div>

      <!-- T1 / T2 indicators -->
      <div class="mini-t12-wrapper" id="t12Wrapper">
        <div class="mini-t12">
          <div class="mini-ring paused" id="ringT1"></div>
          <div>
            <div class="mini-label">T1 – Machine</div>
            <div class="mini-value" id="t1Indicator">0.0 s</div>
          </div>
        </div>
        <div class="mini-t12">
          <div class="mini-ring paused" id="ringT2"></div>
          <div>
            <div class="mini-label">T2 – Load/Unload</div>
            <div class="mini-value" id="t2Indicator">0.0 s</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- REST OF CONTENT -->
  <div class="content-section">

    <!-- Process Capacity Overview -->
    <div class="section-card">
      <div class="section-title">Process Capacity Overview</div>
      <table id="overviewTable">
        <thead>
          <tr>
            <th>Process</th>
            <th>Mode</th>
            <th>N</th>
            <th>CTmed (s)</th>
            <th>Cap 100%</th>
            <th>Cap @Eff</th>
            <th>% vs contract</th>
          </tr>
        </thead>
        <tbody id="overviewBody">
        </tbody>
      </table>
    </div>

    <!-- Contract vs Capacity Summary -->
    <div class="section-card">
      <div class="section-title">Contract vs Capacity Summary</div>
      <div id="contractSummary" style="font-size:.78rem;"></div>
    </div>

    <!-- Stats focus -->
    <div class="section-card">
      <div class="section-title">Stats Focus</div>
      <div class="stats-focus" id="statsFocus">
        <!-- lines injected -->
      </div>
      <div style="margin-top:6px;font-size:.68rem;color:var(--text-muted);">
        Sample size and stability comments are approximate and meant to guide where to focus measurements.
      </div>
    </div>

    <!-- Copy buttons -->
    <div class="section-card">
      <div class="section-title">Data Controls</div>
      <div class="btn-row-secondary">
        <button class="btn-small" id="btnCopyAll">Copy All</button>
        <button class="btn-small" id="btnCopySummary">Copy Summary</button>
        <button class="btn-small" id="btnAddManualLap">Add Manual Lap</button>
        <button class="btn-small" id="btnReset">Reset</button>
      </div>
    </div>

    <!-- Raw data table -->
    <div class="section-card">
      <div class="section-title">Raw Time Data</div>
      <div style="max-height:320px;overflow:auto;">
        <table id="dataTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Process</th>
              <th>Mode</th>
              <th>Status</th>
              <th>Note</th>
              <th>T1 (s)</th>
              <th>T2 (s)</th>
              <th>Total (s)</th>
              <th>Del</th>
            </tr>
          </thead>
          <tbody id="dataBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <div class="footer-note">
    Created by Roberto González
  </div>
</div>

<script>
(function(){
  const display = document.getElementById('display');
  const btnStart = document.getElementById('btnStart');
  const btnLap = document.getElementById('btnLap');
  const timerCard = document.getElementById('timerCard');

  const processInput = document.getElementById('processName');
  const modeSelect   = document.getElementById('mode');
  const effInput     = document.getElementById('efficiency');
  const pcdInput     = document.getElementById('contractPcd');
  const hInput       = document.getElementById('hoursPerDay');
  const dInput       = document.getElementById('daysPerWeek');
  const capViewSel   = document.getElementById('capView');

  const overviewBody   = document.getElementById('overviewBody');
  const contractSummary= document.getElementById('contractSummary');
  const statsFocusDiv  = document.getElementById('statsFocus');

  const dataBody    = document.getElementById('dataBody');
  const btnCopyAll  = document.getElementById('btnCopyAll');
  const btnCopySum  = document.getElementById('btnCopySummary');
  const btnAddMan   = document.getElementById('btnAddManualLap');
  const btnReset    = document.getElementById('btnReset');

  const ringT1 = document.getElementById('ringT1');
  const ringT2 = document.getElementById('ringT2');
  const t1Indicator = document.getElementById('t1Indicator');
  const t2Indicator = document.getElementById('t2Indicator');

  let running = false;
  let startTime = 0;
  let elapsed = 0;
  let timerId = null;

  let laps = []; // {process, mode, status, note, t1, t2, total}
  let nextId = 1;

  let pendingT1 = null; // for MLD

  function pad2(n){return n<10?'0'+n:''+n;}
  function formatTime(ms){
    const total = Math.max(ms,0);
    const mins = Math.floor(total/60000);
    const secs = Math.floor((total%60000)/1000);
    const cent = Math.floor((total%1000)/10);
    return pad2(mins)+':'+pad2(secs)+'.'+pad2(cent);
  }
  function formatSecs(s){
    if(!isFinite(s)) return '-';
    return (Math.round(s*10)/10).toFixed(1);
  }

  function updateDisplay(){
    display.textContent = formatTime(elapsed);
  }

  function tick(){
    const now = performance.now();
    elapsed = now - startTime;
    updateDisplay();
    // update T1/T2 indicators if needed
    if(running && modeSelect.value === 'MLD'){
      if(pendingT1 === null){
        t1Indicator.textContent = formatSecs(elapsed/1000)+' s';
      }else{
        const t2 = (elapsed/1000) - pendingT1;
        t2Indicator.textContent = formatSecs(t2)+' s';
      }
    }
    timerId = requestAnimationFrame(tick);
  }

  function start(){
    if(running) return;
    running = true;
    startTime = performance.now() - elapsed;
    timerId = requestAnimationFrame(tick);
    btnStart.textContent = 'Pause';
    ringT1.classList.remove('paused');
    ringT2.classList.remove('paused');
  }

  function pause(){
    if(!running) return;
    running = false;
    cancelAnimationFrame(timerId);
    timerId = null;
    btnStart.textContent = 'Start';
    ringT1.classList.add('paused');
    ringT2.classList.add('paused');
  }

  btnStart.addEventListener('click',()=>{
    if(running) pause(); else start();
  });

  function smallVibration(){
    if(navigator.vibrate){
      try{navigator.vibrate(35);}catch(e){}
    }
  }
  function flashCard(){
    timerCard.classList.add('flash');
    setTimeout(()=>timerCard.classList.remove('flash'),120);
  }

  function addLap(manualData){
    // ensure process & mode have sensible defaults
    let proc = (processInput.value||'').trim();
    if(!proc){
      proc = 'Process 1';
      processInput.value = proc;
    }
    let mode = modeSelect.value || 'CT';
    modeSelect.value = mode;

    const status = ''; // free text later if needed
    const note = '';

    if(manualData){
      const {t1,t2,total} = manualData;
      laps.push({id:nextId++, process:proc, mode, status, note, t1, t2, total});
      renderAll();
      return;
    }

    // normal from timer
    const seconds = elapsed/1000;

    if(mode === 'CT'){
      laps.push({
        id:nextId++,
        process:proc,
        mode,
        status,
        note,
        t1:seconds,
        t2:0,
        total:seconds
      });
      elapsed = 0;
      updateDisplay();
      t1Indicator.textContent='0.0 s';
      t2Indicator.textContent='0.0 s';
      pendingT1 = null;
      renderAll();
      return;
    }

    // MLD mode
    if(pendingT1 === null){
      // capture T1
      pendingT1 = seconds;
      t1Indicator.textContent = formatSecs(pendingT1)+' s';
      // reset base for T2
      elapsed = 0;
      startTime = performance.now();
      return;
    }else{
      const t2 = seconds;
      const t1 = pendingT1;
      const total = t1 + t2;
      laps.push({
        id:nextId++,
        process:proc,
        mode,
        status,
        note,
        t1,
        t2,
        total
      });
      pendingT1 = null;
      t1Indicator.textContent='0.0 s';
      t2Indicator.textContent='0.0 s';
      elapsed = 0;
      updateDisplay();
      renderAll();
    }
  }

  btnLap.addEventListener('click',()=>{
    smallVibration();
    flashCard();
    addLap();
  });

  btnAddMan.addEventListener('click',()=>{
    const t1 = parseFloat(prompt('T1 (s) – leave blank if not used',''));
    const t2 = parseFloat(prompt('T2 (s) – leave blank if not used',''));
    if(isNaN(t1) && isNaN(t2)) return;
    const v1 = isNaN(t1)?0:t1;
    const v2 = isNaN(t2)?0:t2;
    addLap({t1:v1,t2:v2,total:v1+v2});
  });

  btnReset.addEventListener('click',()=>{
    pause();
    elapsed = 0;
    updateDisplay();
    laps = [];
    nextId = 1;
    pendingT1 = null;
    t1Indicator.textContent='0.0 s';
    t2Indicator.textContent='0.0 s';
    renderAll();
  });

  function renderAll(){
    renderDataTable();
    renderOverview();
    renderContractSummary();
    renderStatsFocus();
  }

  function renderDataTable(){
    dataBody.innerHTML='';
    laps.forEach((lap,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${lap.process}</td>
        <td>${lap.mode}</td>
        <td>${lap.status||''}</td>
        <td>${lap.note||''}</td>
        <td>${formatSecs(lap.t1)}</td>
        <td>${formatSecs(lap.t2)}</td>
        <td>${formatSecs(lap.total)}</td>
        <td><button data-id="${lap.id}" class="btn-del" style="background:${'transparent'};border:none;color:${'#ff8a80'};cursor:pointer;font-weight:700;">X</button></td>
      `;
      dataBody.appendChild(tr);
    });

    dataBody.querySelectorAll('.btn-del').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = parseInt(btn.getAttribute('data-id'),10);
        laps = laps.filter(l=>l.id!==id);
        renderAll();
      });
    });
  }

  function groupByProcess(){
    const map = new Map();
    laps.forEach(l=>{
      const key = l.process+'||'+l.mode;
      if(!map.has(key)) map.set(key,[]);
      map.get(key).push(l);
    });
    return map;
  }

  function calcStats(arr){
    if(!arr.length) return null;
    const values = arr.map(x=>x.total).slice().sort((a,b)=>a-b);
    const n = values.length;
    const mean = values.reduce((s,v)=>s+v,0)/n;
    const median = n%2?values[(n-1)/2]:(values[n/2-1]+values[n/2])/2;
    const min = values[0];
    const max = values[n-1];
    const variance = values.reduce((s,v)=>s+Math.pow(v-mean,2),0)/(n-1||1);
    const std = Math.sqrt(variance);

    function percentile(p){
      if(n===1) return values[0];
      const idx = (n-1)*p;
      const lo = Math.floor(idx);
      const hi = Math.ceil(idx);
      if(lo===hi) return values[lo];
      return values[lo] + (values[hi]-values[lo])*(idx-lo);
    }
    const p10 = percentile(0.1);
    const p90 = percentile(0.9);
    const cv = mean ? std/mean : 0;

    return {n,values,mean,median,min,max,std,p10,p90,cv};
  }

  function renderOverview(){
    overviewBody.innerHTML='';
    const groups = groupByProcess();
    const eff = Math.min(Math.max(parseFloat(effInput.value)||100,10),100);
    const hours = Math.min(Math.max(parseFloat(hInput.value)||8,1),24);
    const days  = Math.min(Math.max(parseInt(dInput.value)||5,1),7);
    const pcd   = parseFloat(pcdInput.value)||0;
    const view  = capViewSel.value;

    groups.forEach((arr,key)=>{
      const [proc,mode] = key.split('||');
      const stats = calcStats(arr);
      if(!stats) return;
      const ctMed = stats.median;
      let cap100 = 0;
      if(ctMed>0){
        const perHour = 3600/ctMed;
        if(view==='hour') cap100 = perHour;
        else if(view==='day') cap100 = perHour*hours;
        else cap100 = perHour*hours*days;
      }
      const capEff = cap100*(eff/100);

      let contractUnits = 0;
      if(pcd>0){
        if(view==='hour') contractUnits = (pcd/hours)||0;
        else if(view==='day') contractUnits = pcd;
        else contractUnits = pcd*days;
      }
      let pctVs = contractUnits>0 ? (capEff/contractUnits*100) : 0;
      let badgeClass = '';
      let badgeText = '';
      if(contractUnits>0){
        if(pctVs<85){badgeClass='badge-bad';badgeText=pctVs.toFixed(0)+'%';}
        else if(pctVs<100){badgeClass='badge-warn';badgeText=pctVs.toFixed(0)+'%';}
        else{badgeClass='badge-good';badgeText=pctVs.toFixed(0)+'%';}
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${proc}</td>
        <td>${mode}</td>
        <td>${stats.n}</td>
        <td>${formatSecs(ctMed)}</td>
        <td>${cap100?cap100.toFixed(1):'-'}</td>
        <td>${capEff?capEff.toFixed(1):'-'}</td>
        <td>${contractUnits>0?`<span class="badge ${badgeClass}">${badgeText}</span>`:'-'}</td>
      `;
      overviewBody.appendChild(tr);
    });
  }

  function renderContractSummary(){
    const groups = groupByProcess();
    const eff = Math.min(Math.max(parseFloat(effInput.value)||100,10),100);
    const hours = Math.min(Math.max(parseFloat(hInput.value)||8,1),24);
    const days  = Math.min(Math.max(parseInt(dInput.value)||5,1),7);
    const pcd   = parseFloat(pcdInput.value)||0;
    const view  = capViewSel.value;
    contractSummary.innerHTML='';

    if(!groups.size){
      contractSummary.innerHTML='<span style="color:var(--text-muted);">No data yet. Take a few laps to see capacity vs contract.</span>';
      return;
    }

    const frag = document.createDocumentFragment();

    groups.forEach((arr,key)=>{
      const [proc,mode] = key.split('||');
      const stats = calcStats(arr);
      if(!stats) return;
      const ctMed = stats.median;
      if(!ctMed) return;
      let perHour = 3600/ctMed;
      let cap100 = 0;
      if(view==='hour') cap100 = perHour;
      else if(view==='day') cap100 = perHour*hours;
      else cap100 = perHour*hours*days;

      const capEff = cap100*(eff/100);

      let contractUnits = 0;
      if(pcd>0){
        if(view==='hour') contractUnits = (pcd/hours)||0;
        else if(view==='day') contractUnits = pcd;
        else contractUnits = pcd*days;
      }

      let pct = contractUnits>0 ? (capEff/contractUnits*100) : 0;
      let tagClass='badge-warn';
      let label='No contract loaded';
      if(contractUnits>0){
        if(pct<85){tagClass='badge-bad';label=pct.toFixed(0)+'% vs contract';}
        else if(pct<100){tagClass='badge-warn';label=pct.toFixed(0)+'% vs contract';}
        else{tagClass='badge-good';label=pct.toFixed(0)+'% vs contract';}
      }

      const div = document.createElement('div');
      div.style.marginBottom='4px';
      div.innerHTML = `
        <span style="font-weight:600;">${proc} (${mode})</span> – median CT <span style="font-weight:600;">${formatSecs(ctMed)} s</span>,
        capacity @Eff ≈ <span style="font-weight:600;">${capEff?capEff.toFixed(1):'-'} units/${view}</span>
        ${contractUnits>0?`<span class="badge ${tagClass}" style="margin-left:4px;">${label}</span>`:''}
      `;
      frag.appendChild(div);
    });

    contractSummary.appendChild(frag);
  }

  function renderStatsFocus(){
    statsFocusDiv.innerHTML='';
    const groups = groupByProcess();
    if(!groups.size){
      statsFocusDiv.innerHTML='<div class="focus-line focus-warn">No samples yet. Take at least 10–15 laps on the bottleneck process.</div>';
      return;
    }

    groups.forEach((arr,key)=>{
      const [proc,mode] = key.split('||');
      const st = calcStats(arr);
      if(!st) return;
      const n = st.n;
      const cv = st.cv;
      const mean = st.mean;
      const med = st.median;

      // sample size heuristic
      let recN;
      if(cv<=0.10) recN = 10;
      else if(cv<=0.20) recN = 15;
      else if(cv<=0.30) recN = 25;
      else recN = 40;

      const ratio = n/recN;
      let sampleClass='focus-warn';
      let sampleMsg = `Sample size ${n}/${recN} – add a few more laps.`;
      if(ratio<0.6){
        sampleClass='focus-bad';
        sampleMsg = `Sample size ${n}/${recN} – too low, keep measuring.`;
      }else if(ratio<0.9){
        sampleClass='focus-warn';
        sampleMsg = `Sample size ${n}/${recN} – almost enough, 1–2 more sets would help.`;
      }else{
        sampleClass='focus-good';
        sampleMsg = `Sample size ${n}/${recN} – good enough for a quick decision.`;
      }

      // variation
      let varClass='focus-warn';
      let varMsg='Moderate variation – check method and operator.';
      if(cv<0.08){varClass='focus-good';varMsg='Low variation – process looks stable.';}
      else if(cv>0.2){varClass='focus-bad';varMsg='High variation – timings jump too much, process not stable.';}

      // symmetry
      const diff = Math.abs(mean-med);
      let symClass='focus-good';
      let symMsg='Mean and median are close – data roughly symmetric.';
      if(diff>0.2*med){
        symClass='focus-warn';
        symMsg='Mean and median are far apart – data skewed, watch for outliers.';
      }

      const block = document.createElement('div');
      block.style.marginBottom='6px';
      block.innerHTML = `
        <div style="font-weight:600;margin-bottom:2px;">${proc} (${mode})</div>
        <div class="focus-line ${sampleClass}">${sampleMsg}</div>
        <div class="focus-line ${varClass}">Std dev ≈ ${formatSecs(st.std)} s (${(cv*100).toFixed(1)}% of mean) – ${varMsg}</div>
        <div class="focus-line ${symClass}">Mean ≈ ${formatSecs(mean)} s, Median ≈ ${formatSecs(med)} s. ${symMsg}</div>
      `;
      statsFocusDiv.appendChild(block);
    });
  }

  async function copyToClipboard(text){
    if(!text) return;
    try{
      await navigator.clipboard.writeText(text);
      alert('Copied.');
    }catch(e){
      // fallback
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      try{
        document.execCommand('copy');
        alert('Copied.');
      }catch(err){
        alert('Clipboard not available. You can long-press and copy manually.');
      }
      document.body.removeChild(ta);
    }
  }

  btnCopyAll.addEventListener('click',()=>{
    if(!laps.length){
      alert('No data to copy.');
      return;
    }
    const header = ['#','Process','Mode','Status','Note','T1 (s)','T2 (s)','Total (s)'];
    const rows = laps.map((l,i)=>[
      i+1,
      l.process,
      l.mode,
      l.status||'',
      l.note||'',
      formatSecs(l.t1),
      formatSecs(l.t2),
      formatSecs(l.total)
    ].join('\t'));
    copyToClipboard(header.join('\t')+'\n'+rows.join('\n'));
  });

  btnCopySum.addEventListener('click',()=>{
    const groups = groupByProcess();
    if(!groups.size){
      alert('No summary to copy.');
      return;
    }
    const lines = [];
    groups.forEach((arr,key)=>{
      const [proc,mode] = key.split('||');
      const st = calcStats(arr);
      if(!st) return;
      lines.push(
        `${proc} (${mode})\tN=${st.n}\tMean=${formatSecs(st.mean)}s\tMedian=${formatSecs(st.median)}s\tStd=${formatSecs(st.std)}s\tMin=${formatSecs(st.min)}s\tMax=${formatSecs(st.max)}s`
      );
    });
    copyToClipboard(lines.join('\n'));
  });

  // initial render
  renderAll();
})();
</script>
</body>
</html>
